<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="he" dir="rtl">
<body>
<div th:fragment="content">
  <div class="container-fluid px-4 py-3 border-bottom bg-light">
	
	<!-- Flash Messages -->
	<div th:if="${successMessage}" class="alert alert-success alert-dismissible fade show" role="alert">
	  <span th:text="${successMessage}"></span>
	  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
	
	<div th:if="${errorMessage}" class="alert alert-danger alert-dismissible fade show" role="alert">
	  <span th:text="${errorMessage}"></span>
	  <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
	</div>
	
	<!-- Main Heading Section -->
	<div class="row align-items-center justify-content-center mb-4">
	  <!-- Left Side Buttons -->
	  <div class="col-md-3 text-end">
		<div class="d-flex gap-2 justify-content-end">
		  <<!-- Document button -->
		  <button class="btn btn-outline-primary d-flex flex-column align-items-center p-2"
				  data-bs-toggle="modal"
				  data-bs-target="#addDocumentModal"
				  title="הוסף מסמך">
			<i class="bi bi-file-earmark-text fs-5 mb-1"></i>
			<span class="small">הוסף מסמך</span>
		  </button>
		  
		  <!-- Image button -->
		  <button class="btn btn-outline-primary d-flex flex-column align-items-center p-2"
				  data-bs-toggle="modal"
				  data-bs-target="#addImageModal"
				  title="הוסף תמונה">
			<i class="bi bi-image fs-5 mb-1"></i>
			<span class="small">הוסף תמונה</span>
		  </button>
		  
		  <!-- Add Text Message Button with Modal -->
		  <button class="btn btn-outline-primary d-flex flex-column align-items-center p-2"
				  data-bs-toggle="modal"
				  data-bs-target="#addTextMessageModal"
				  title="הוסף הודעת טקסט">
			<i class="bi bi-chat-text fs-5 mb-1"></i>
			<span class="small">הוסף טקסט</span>
		  </button>
		</div>
	  </div>
	  
	  <!-- Centered Heading (Middle) -->
	  <div class="col-md-6 text-center">
		<h2 class="display-6 mb-2">ניהול הודעות</h2>
		<div class="d-flex justify-content-center gap-3 text-muted small">
		  <div class="d-flex align-items-center">
			<i class="bi bi-folder me-2"></i>
			<span th:text="${#maps.size(categories)}">0</span>
			<span class="ms-1">קטגוריות</span>
		  </div>
		  <div class="d-flex align-items-center">
			<i class="bi bi-chat-dots me-2"></i>
			<span th:text="${totalMessages}">0</span>
			<span class="ms-1">הודעות</span>
		  </div>
		</div>
	  </div>
	  
	  <!-- Right Side (Empty for symmetry) -->
	  <div class="col-md-3"></div>
	</div>
	
	<!-- Categories Grid -->
	<div class="row row-cols-1 row-cols-sm-2 row-cols-md-3 row-cols-lg-4 g-4">
	  <!-- Category Cards -->
	  <div th:each="category : ${categories}" class="col">
		<div class="card h-100 shadow-sm">
		  <div class="card-body">
			<h5 class="card-title d-flex justify-content-between align-items-center mb-3">
			  <span th:text="${category.key}">Category Name</span>
			  <span class="badge bg-primary rounded-pill"
					th:text="${#maps.size(category.value)}">0</span>
			</h5>
			
			<!-- Subcategories -->
			<div class="list-group list-group-flush">
			  <div th:each="subcategory : ${category.value}" class="list-group-item border-0 px-0">
				<div class="d-flex justify-content-between align-items-center mb-2">
				  <h6 class="mb-0" th:text="${subcategory.key}">Subcategory Name</h6>
				  <span class="badge bg-secondary rounded-pill"
						th:text="${#lists.size(subcategory.value)}">0</span>
				</div>
				
				<!-- Virtual Scrolling Container for Messages -->
				<div class="messages-container" style="max-height: 200px; overflow-y: auto;">
				  <div class="d-flex flex-wrap gap-2">
					<div th:each="message, messageStat : ${subcategory.value}"
						 class="message-item"
						 th:if="${messageStat.index < 50}">
					  <button class="btn btn-sm btn-outline-primary d-flex align-items-center gap-2"
							  data-bs-toggle="modal"
							  th:data-bs-target="'#message-modal-' + ${message.id}">
                        <span class="message-preview"
							  th:text="${#strings.abbreviate(message.messageContent, 20)}">
                          Message...
                        </span>
					  </button>
					</div>
					<div th:if="${#lists.size(subcategory.value) > 50}"
						 class="text-muted small">
					  <button class="btn btn-sm btn-link"
							  th:onclick="'loadMoreMessages(\'' + ${category.key} + '\', \'' + ${subcategory.key} + '\')'">
						טען עוד...
					  </button>
					</div>
				  </div>
				</div>
			  </div>
			</div>
		  </div>
		</div>
	  </div>
	</div>
	
	<!-- Individual Message Modals -->
	<div th:each="category : ${categories}">
	  <div th:each="subcategory : ${category.value}">
		<div th:each="message : ${subcategory.value}" class="modal fade"
			 th:id="'message-modal-' + ${message.id}" tabindex="-1"
			 th:aria-labelledby="'messageLabel-' + ${message.id}" aria-hidden="true">
		  <div class="modal-dialog modal-dialog-centered">
			<div class="modal-content">
			  <div class="modal-header bg-light p-2 border-0">
				<div class="container-fluid p-0">
				  <div class="row g-2">
					<div class="col-3">
					  <!-- Copy Button -->
					  <button type="button"
							  class="btn btn-outline-secondary w-100 p-2 rounded-3 copy-button"
							  data-bs-toggle="tooltip"
							  data-bs-placement="top"
							  th:data-content="${message.messageContent}"
							  title="העתק">
						<i class="bi bi-clipboard fs-5 d-block mb-1"></i>
						<span class="d-block small">העתק תוכן</span>
					  </button>
					</div>
					<!-- Regular Edit Button -->
					<div class="col-3">
					  <button type="button"
							  class="btn btn-outline-primary w-100 p-2 rounded-3"
							  onclick="toggleMode(this, 'edit')"
							  data-bs-toggle="tooltip"
							  data-bs-placement="top"
							  title="ערוך">
						<i class="bi bi-pencil-square fs-5 d-block mb-1"></i>
						<span class="d-block small edit-text">ערוך</span>
					  </button>
					</div>
					<!-- Smart Edit Button -->
					<div class="col-3">
					  <button type="button"
							  class="btn btn-outline-info w-100 p-2 rounded-3"
							  onclick="toggleMode(this, 'smart')"
							  data-bs-toggle="tooltip"
							  data-bs-placement="top"
							  title="עריכה חכמה">
						<i class="bi bi-stars fs-5 d-block mb-1"></i>
						<span class="d-block small smart-edit-text">עריכה חכמה</span>
					  </button>
					</div>
					<!-- Delete Button -->
					<div class="col-3">
					  <form th:action="@{/messages/delete}" method="post" class="m-0">
						<input type="hidden" name="messageId" th:value="${message.id}" />
						<button type="submit"
								class="btn btn-outline-danger w-100 p-2 rounded-3"
								data-bs-toggle="tooltip"
								data-bs-placement="top"
								title="מחק"
								onclick="return confirm('האם אתה בטוח שברצונך למחוק הודעה זו?');">
						  <i class="bi bi-trash fs-5 d-block mb-1"></i>
						  <span class="d-block small">מחק</span>
						</button>
					  </form>
					</div>
				  </div>
				</div>
				
				<button type="button"
						class="btn-close position-absolute top-0 end-0 mt-2 me-2"
						data-bs-dismiss="modal"
						aria-label="Close">
				</button>
			  </div>
			  
			  <!-- Modal Body with View/Edit Forms -->
			  <div class="modal-body">
				<!-- View Mode Content -->
				<div class="view-mode">
				  <!-- Message Details -->
				  <div class="message-details mb-4">
					<div class="row mb-3">
					  <div class="col-6">
						<strong>סוג:</strong>
						<span class="badge bg-dark ms-2" th:text="${message.type}">Type</span>
					  </div>
					  <div class="col-6">
						<strong>מטרה:</strong>
						<span class="badge bg-dark ms-2" th:text="${message.purpose}">Purpose</span>
					  </div>
					</div>
				  </div>
				  
				  <!-- Message Content -->
				  <div class="message-content mb-4">
					<strong>תוכן:</strong>
					<p class="shadow-whatsapp" th:text="${message.messageContent}">Message Content</p>
				  </div>
				  
				  <!-- Tags and Next Steps -->
				  <div class="tags-section">
					<div th:if="${message.tags}" class="mb-3">
					  <strong>תגיות:</strong>
					  <div class="d-flex gap-2 flex-wrap mt-1">
                    <span th:each="tag : ${message.tags}"
						  class="badge bg-info" th:text="${tag}">Tag</span>
					  </div>
					</div>
					<div th:if="${message.nextSteps}" class="mb-3">
					  <strong>צעדים הבאים:</strong>
					  <div class="d-flex gap-2 flex-wrap mt-1">
                    <span th:each="step : ${message.nextSteps}"
						  class="badge bg-success" th:text="${step}">Step</span>
					  </div>
					</div>
				  </div>
				</div>
				
				<!-- Regular Edit Mode -->
				<form class="edit-mode d-none" th:action="@{/messages/update}" method="post">
				  <input type="hidden" name="messageId" th:value="${message.id}" />
				  <input type="hidden" name="editMode" value="regular" />
				  
				  <!-- Type and Purpose -->
				  <div class="row mb-3">
					<div class="col-6">
					  <label class="form-label">סוג:</label>
					  <input type="text" class="form-control" name="type"
							 th:value="${message.type}" required>
					</div>
					<div class="col-6">
					  <label class="form-label">מטרה:</label>
					  <input type="text" class="form-control" name="purpose"
							 th:value="${message.purpose}" required>
					</div>
				  </div>
				  
				  <!-- Message Content -->
				  <div class="mb-3">
					<label class="form-label">תוכן:</label>
					<textarea class="form-control" name="messageContent"
							  rows="4" required th:text="${message.messageContent}"></textarea>
				  </div>
				  
				  <!-- Tags -->
				  <div class="mb-3">
					<label class="form-label">תגיות (הפרד בפסיקים):</label>
					<input type="text" class="form-control" name="tags"
						   th:value="${#strings.listJoin(message.tags, ', ')}">
				  </div>
				  
				  <!-- Next Steps -->
				  <div class="mb-3">
					<label class="form-label">צעדים הבאים (הפרד בפסיקים):</label>
					<input type="text" class="form-control" name="nextSteps"
						   th:value="${#strings.listJoin(message.nextSteps, ', ')}">
				  </div>
				  
				  <!-- Save/Cancel Buttons -->
				  <div class="d-flex gap-2 justify-content-end">
					<button type="button" class="btn btn-secondary" onclick="toggleEditMode(this)">ביטול</button>
					<button type="submit" class="btn btn-primary">שמור</button>
				  </div>
				</form>
				
				<!-- Smart Edit Mode -->
				<form class="smart-edit-mode d-none" th:action="@{/messages/smartUpdate}" method="post">
				  <input type="hidden" name="messageId" th:value="${message.id}" />
				  <input type="hidden" name="editMode" value="smart" />

				  <!-- Only Message Content is Editable -->
				  <div class="mb-3">
					<label class="form-label">תוכן:</label>
					<textarea class="form-control" name="messageContent"
							  rows="4" required th:text="${message.messageContent}"></textarea>
				  </div>
				  
				  <!-- Save/Cancel Buttons -->
				  <div class="d-flex gap-2 justify-content-end">
					<button type="button" class="btn btn-secondary" onclick="toggleMode(this, 'view')">ביטול</button>
					<button type="submit" class="btn btn-primary">שמור</button>
				  </div>
				</form>
				
				<div class="text-muted mt-3">
				  <small th:text="${message.createdAt}">Date</small>
				</div>
			  </div>
			</div>
		  </div>
		</div>
	  </div>
	</div>
	
	<!-- Document Upload Modal -->
	<div class="modal fade" id="addDocumentModal" tabindex="-1" aria-labelledby="addDocumentModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="addDocumentModalLabel">הוסף מסמך חדש</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		  </div>
		  <form th:action="@{/messages/media}"
				method="post"
				enctype="multipart/form-data"
				class="m-0">
			<div class="modal-body">
			  <input type="hidden" name="phoneNumber" th:value="${phone}" />
			  <input type="hidden" name="type" value="document" />
			  
			  <div class="mb-3">
				<div class="d-flex flex-column align-items-center justify-content-center p-5 bg-light rounded-3 border-2 border-dashed position-relative"
					 id="documentDropZone"
					 th:data-upload-zone="true">
				  <!-- Upload Icon and Text -->
				  <div class="text-center mb-3">
					<i class="bi bi-file-earmark-text display-4 text-secondary mb-3"></i>
					<h5 class="mb-2 text-secondary">גרור קבצים לכאן</h5>
					<p class="text-muted mb-3">או</p>
				  </div>
				  
				  <div class="input-group">
					<input type="file"
						   class="form-control"
						   id="documentInput"
						   name="file"
						   accept=".pdf,.doc,.docx,.txt"
						   required
						   th:data-bs-file-input="true">
				  </div>
				  
				  <!-- File Preview -->
				  <div id="documentPreview" class="mt-3 w-100 d-none">
					<div class="alert alert-info d-flex align-items-center">
					  <i class="bi bi-file-earmark me-2"></i>
					  <span id="documentFileName"></span>
					  <button type="button" class="btn-close ms-auto" onclick="clearFileInput('documentInput')"></button>
					</div>
				  </div>
				</div>
			  </div>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
			  <button type="submit" class="btn btn-primary">שמור מסמך</button>
			</div>
		  </form>
		</div>
	  </div>
	</div>
	
	<!-- Image Upload Modal -->
	<div class="modal fade" id="addImageModal" tabindex="-1" aria-labelledby="addImageModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="addImageModalLabel">הוסף תמונה חדשה</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		  </div>
		  <form th:action="@{/messages/media}"
				method="post"
				enctype="multipart/form-data"
				class="m-0">
			<div class="modal-body">
			  <input type="hidden" name="phoneNumber" th:value="${phone}" />
			  <input type="hidden" name="type" value="image" />
			  
			  <div class="mb-3">
				<div class="d-flex flex-column align-items-center justify-content-center p-5 bg-light rounded-3 border-2 border-dashed position-relative"
					 id="imageDropZone"
					 th:data-upload-zone="true">
				  <!-- Upload Icon and Text -->
				  <div class="text-center mb-3">
					<i class="bi bi-image display-4 text-secondary mb-3"></i>
					<h5 class="mb-2 text-secondary">גרור תמונות לכאן</h5>
					<p class="text-muted mb-3">או</p>
				  </div>
				  
				  <!-- File Input Group -->
				  <div class="input-group">
					<input type="file"
						   class="form-control"
						   id="imageInput"
						   name="file"
						   accept="image/*"
						   required
						   th:data-bs-file-input="true">
				  </div>
				  
				  <!-- Image Preview -->
				  <div id="imagePreview" class="mt-3 w-100 d-none">
					<div class="alert alert-info d-flex align-items-center">
					  <i class="bi bi-image me-2"></i>
					  <span id="imageFileName"></span>
					  <button type="button" class="btn-close ms-auto" onclick="clearFileInput('imageInput')"></button>
					</div>
					<img id="imagePreviewElement" class="img-fluid rounded mt-2 d-none" alt="תצוגה מקדימה">
				  </div>
				</div>
			  </div>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
			  <button type="submit" class="btn btn-primary">שמור תמונה</button>
			</div>
		  </form>
		</div>
	  </div>
	</div>
	
	<!-- Add Text Message Modal -->
	<div class="modal fade" id="addTextMessageModal" tabindex="-1" aria-labelledby="addTextMessageModalLabel" aria-hidden="true">
	  <div class="modal-dialog modal-dialog-centered">
		<div class="modal-content">
		  <div class="modal-header">
			<h5 class="modal-title" id="addTextMessageModalLabel">הוסף הודעת טקסט חדשה</h5>
			<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
		  </div>
		  <form th:action="@{/messages/text}" method="post" class="m-0">
			<div class="modal-body">
			  <input type="hidden" name="phoneNumber" th:value="${phone}" />
			  <div class="mb-3">
				<label for="messageContent" class="form-label">תוכן ההודעה</label>
				<textarea class="form-control"
						  id="messageContent"
						  name="content"
						  rows="4"
						  required></textarea>
			  </div>
			</div>
			<div class="modal-footer">
			  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ביטול</button>
			  <button type="submit" class="btn btn-primary">שמור הודעה</button>
			</div>
		  </form>
		</div>
	  </div>
	</div>
  </div>
</div>
</body>
</html>